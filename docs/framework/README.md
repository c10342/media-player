# 架构设计

本章节将介绍播放器的整体架构设计。通过了解播放器的整体架构设计将有助于你对播放器进行二次开发或者开发组件、插件等定制化需求

## 初始化流程

播放器参考了`express`的中间件模型，通过中间件的形式将插件、组件、钩子函数、Tech 等初始化串联起来的。整个播放器初始化流程可能同步的，也可能是异步的，这取决于你的操作。如果你的操作中包含了异步操作，那么整个流程就是异步的，此时如果你需要使用播放器实例上面的功能，你需要在`player.ready(()=>{})`函数的回调函数中进行使用。

整个初始化流程如下：

![初始化流程](/images/init.png)

**执行 beforeSetup 钩子函数**

这个阶段将会执行通过`Player.useHook`函数注册的`beforeSetup`钩子函数。在这个阶段，你可以对用户传入的配置进行操作，比如修改一个配置或者新增一个配置

**合并配置**

这个阶段将会把用户配置跟默认的配置进行合并，形成一个新的配置，并挂载到播放器实例中

**初始化国际化语言包**

这个阶段将会根据初始化配置对语言包进行性初始化，目前支持中文和英文，当然你也可以进行自定义

**初始化插件**

这个阶段将会对插件进行初始化。关于对插件的介绍，详情可查看[插件章节](/plugins/guide/)

**初始化 DOM 容器**

这个阶段主要做的是生成一个 `DOM` 容器，并插入到用户指定的节点当中。这个阶段的目的是提供一些插槽给组件插入 `DOM` 节点

**初始化组件**

这个阶段将会对组件进行初始化。关于对组件的介绍，详情可查看[组件章节](/components/guide/)

**执行 source 资源中间件**

这个阶段将会执行通过`Player.useSource`函数注册的中间件。在这个阶段你可以对即将要播放的视频地址，类型等信息进行修改

**初始化 Tech**

这个阶段将会对 Tech 进行初始化。关于对 Tech 的介绍，详情可查看[Tech 章节](/techs/guide/)

**执行 afterSetup 钩子函数**

这个阶段将会执行通过`Player.useHook`函数注册的`afterSetup`钩子函数。在这个阶段，你可以对播放器的实例进行扩展，比如往播放器实例上面新增属性或者函数

## 销毁流程

![销毁流程](/images/destroy.png)

**执行 beforeDestroy 钩子函数**

这个阶段将会执行通过`Player.useHook`函数注册的`beforeDestroy`钩子函数。在这个阶段你可以清除一些副作用代码

**触发 destroy 事件**

这个阶段将会对外广播`destroy`事件。你可以在这个事件毁掉中清除一些副作用代码

**销毁插件**

这个阶段将会对所有的插件进行销毁

**销毁组件**

这个阶段将会对所有的组件进行销毁

**销毁 Tech**

这个阶段将会对 Tech 进行销毁。在这个阶段，你可以清除一些副作用代码，比如`hls.js`的拉流

**销毁事件监听**

这个阶段将会销毁`player.$on`或者`player.$once`监听的事件

**销毁 DOM 布局**

这个阶段将会移除所有的`DOM`元素

**销毁相关对象**

这个阶段将会播放器实例上面的一些属性销毁，释放内存

**执行 afterDestroy 钩子函数**

这个阶段将会执行通过`Player.useHook`函数注册的`afterDestroy`钩子函数。在这个阶段你可以清除一些副作用代码

## 播放器组成

![销毁流程](/images/framework.png)

播放器主要有三部分组成，分别是`Plugin`，`Component`，`Tech`，`Hook`，`Source`

- `Plugin`：提供一些扩展的功能

- `Component`：提供 UI 组件，控件等

- `Tech`：可结合`ESM`库实现自定义格式视频播放。比如结合`hls.js`实现`.m3u8`文件的播放

- `Hook`：播放器生命周期中间件

- `Source`：视频播放资源中间件
